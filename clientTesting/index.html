<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #chatBox {
            width: 100%;
            height: 300px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
            padding: 10px;
            overflow-y: scroll;
        }
        #messageInput {
            width: 80%;
            padding: 10px;
        }
        #sendButton {
            padding: 10px 20px;
        }
    </style>
</head>
<body>
    <h2>Real-time Chat</h2>
    <div id="chatBox"></div>
    <input type="text" id="messageInput" placeholder="Type a message...">
    <button id="sendButton">Send</button>

    <script src="socket.io/socket.io.min.js"></script>
    <script>
        let socket;
        let isOnline = false;

        // Initialize socket connection when the page loads
        function initializeSocket() {
            const token = localStorage.getItem('jwtToken'); // Retrieve JWT token from localStorage
            if (!token) {
                console.error('No JWT token found');
                return;
            }

            // Connect to the WebSocket server
            socket = io('http://localhost:3000');  // Ensure the URL matches your server's URL

            // Event: When connected to WebSocket server
            socket.on('connect', () => {
                isOnline = true;
                console.log('Connected to WebSocket');

                // Extract the userId from the JWT token
                const userId = extractUserIdFromToken(token);

                // Emit the 'join' event to the server
                socket.emit('join', { userId });
            });

            // Event: When disconnected from WebSocket server
            socket.on('disconnect', () => {
                isOnline = false;
                console.log('Disconnected from WebSocket');
            });

            // Event: New message received in real-time
            socket.on('receiveMessage', (data) => {
                console.log('Received message:', data);
                displayMessage(data);
            });

            // Event: Handle undelivered messages when reconnecting
            socket.on('undeliveredMessages', (messages) => {
                console.log('Undelivered messages:', messages);
                messages.forEach(displayMessage);
            });
        }

        // Function to extract userId from JWT token
        function extractUserIdFromToken(token) {
            const payload = JSON.parse(atob(token.split('.')[1])); // Decode JWT token
            return payload.userId;  // Assuming the token contains a userId field
        }

        // Send a message to another user
        function sendMessage() {
            const senderId = extractUserIdFromToken(localStorage.getItem('jwtToken'));
            const receiverId = 'user456';  // Example receiver ID (you can dynamically set this)
            const messageContent = document.getElementById('messageInput').value;

            if (!messageContent.trim()) {
                alert('Message cannot be empty!');
                return;
            }

            if (isOnline) {
                // If the user is online, send the message via WebSocket
                socket.emit('sendMessage', { senderId, receiverId, messageContent });
                console.log('Message sent via WebSocket');
            } else {
                // If the user is offline, save the message via the REST API
                sendMessageViaAPI(senderId, receiverId, messageContent);
            }

            document.getElementById('messageInput').value = ''; // Clear the message input field
        }

        // Send message via REST API (for offline users)
        async function sendMessageViaAPI(senderId, receiverId, messageContent) {
            const token = localStorage.getItem('jwtToken');
            const response = await fetch('/api/sendMessage', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ senderId, receiverId, messageContent }),
            });

            const result = await response.json();
            if (result.success) {
                console.log('Message saved to database (offline mode)');
            } else {
                console.log('Failed to send message via API');
            }
        }

        // Display a message in the chat box
        function displayMessage(data) {
            const chatBox = document.getElementById('chatBox');
            const message = document.createElement('div');
            message.textContent = `${data.senderId}: ${data.messageContent} (sent at ${new Date(data.timestamp).toLocaleString()})`;
            chatBox.appendChild(message);

            // Scroll to the bottom of the chat box
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Attach an event listener to the send button
        document.getElementById('sendButton').addEventListener('click', sendMessage);

        // Initialize WebSocket connection when the page loads
        initializeSocket();
    </script>
</body>
</html>
